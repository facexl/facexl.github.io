(window.webpackJsonp=window.webpackJsonp||[]).push([[63],{353:function(s,t,n){"use strict";n.r(t);var a=n(14),e=Object(a.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"使用-jenkins-搭建ci-cd"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用-jenkins-搭建ci-cd"}},[s._v("#")]),s._v(" 使用 jenkins 搭建CI/CD")]),s._v(" "),t("h3",{attrs:{id:"首先用-docker-安装jenkins"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#首先用-docker-安装jenkins"}},[s._v("#")]),s._v(" 首先用 docker 安装jenkins")]),s._v(" "),t("p",[s._v("进入 /etc/docker 目录下，修改 daemon.json 文件，添加如下内容，主要包括一些镜像源：")]),s._v(" "),t("div",{staticClass:"language-json extra-class"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"registry-mirrors"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n\t    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://cf-workers-docker-io-d5y.pages.dev"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://kfwkfulq.mirror.aliyuncs.com"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://2lqq34jg.mirror.aliyuncs.com"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://pee6w651.mirror.aliyuncs.com"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://registry.docker-cn.com"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://hub-mirror.c.163.com"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://do11tfdm.mirror.aliyuncs.com"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"log-driver"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"json-file"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"log-opts"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"max-size"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"100m"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token property"}},[s._v('"max-file"')]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n修改此文件需要重启docker服务\nsystemctl start docker\n\n")])])]),t("h3",{attrs:{id:"编写docker-file"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#编写docker-file"}},[s._v("#")]),s._v(" 编写docker file")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /opt \n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" jenkins "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" jenkins  \n\n编写 jenkins.yml:\n\nversion: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3.4"')]),s._v("\nservices:\n  jenkins:\n    hostname: jenkins\n    image: jenkins/jenkins:2.387.3\n    network_mode: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"bridge"')]),s._v("\n    ports:\n      - "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v(":8080\n      - "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("50000")]),s._v(":50000\n    restart: always\n    privileged: "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n    container_name: jenkins\n    volumes:\n      - ./jenkins_home:/var/jenkins_home\n\n")])])]),t("h3",{attrs:{id:"构建docker镜像"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#构建docker镜像"}},[s._v("#")]),s._v(" 构建docker镜像")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" compose "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" jenkins.yml up "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" // up启动-d后台启动\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" // 查看镜像  \n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" start b102124d029a"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CONTAINER ID"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  启动jenkins  \n\n可能失败 没有目录权限 jenkins_home \n\nchomd "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-R")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("777")]),s._v(" jenkins_home\n\n")])])]),t("h3",{attrs:{id:"打通gitee"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#打通gitee"}},[s._v("#")]),s._v(" 打通gitee")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("安装 gitee 插件")])]),s._v(" "),t("li",[t("p",[s._v("安装 Generic Webhook Trigger 插件")])]),s._v(" "),t("li",[t("p",[s._v("gitee 填写 api?token=(Generic Webhook Trigger在用户管理-用户-设置里面生成的token)")])]),s._v(" "),t("li",[t("p",[s._v("webhook 密码 填写jenkins创建项目那里的密码")])])]),s._v(" "),t("h3",{attrs:{id:"docker-容器内部-sh-操作其他服务器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#docker-容器内部-sh-操作其他服务器"}},[s._v("#")]),s._v(" docker 容器内部 sh 操作其他服务器")]),s._v(" "),t("p",[s._v("webhook触发后我们执行sh会发现此时在docker容器内部 需要登录到其他服务器进行操作")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 以下注释由AI生成")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# (如果没有rsa密钥 可以 ssh-keygen生成一下)")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" id_rsa /opt/docker/jenkins/jenkins_home/  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将id_rsa私钥文件复制到Docker容器挂载的Jenkins主目录下")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" authorized_keys "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看当前的authorized_keys文件内容，里面存储了允许通过SSH公钥认证登录的公钥。")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" id_rsa.pub "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" authorized_keys "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将公钥文件id_rsa.pub的内容追加到authorized_keys文件中，以便允许使用该公钥进行SSH认证")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /opt/docker/jenkins/jenkins_home/ "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 切换到Jenkins主目录，假设这是Jenkins在Docker容器中的数据卷挂载点")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 列出当前目录下的文件和目录，以检查内容是否如预期")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-a")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 列出所有Docker容器，包括正在运行的和已经停止的。")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" b102124d029a "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进入指定ID为b102124d029a的Docker容器内部，并启动一个交互式bash shell")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /var/jenkins_home/ "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在Docker容器内切换到Jenkins的实际主目录")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 看下有没有 rsa ")]),s._v("\n\n\n- 配置SSH公钥认证，以便让Jenkins实例能够通过SSH无密码访问其它系统或服务。\n- 验证并管理Jenkins在Docker容器内的数据\n\n")])])]),t("h3",{attrs:{id:"jenkins-执行脚本举例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#jenkins-执行脚本举例"}},[s._v("#")]),s._v(" jenkins 执行脚本举例")]),s._v(" "),t("div",{staticClass:"language-sh extra-class"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" /var/jenkins_home/id_rsa root@"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("宿主机器内网IP或者其他服务器的公网IP"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"git or build 指令"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这时候可能发现会失败 原因是没有权限访问 /var/jenkins_home/id_rsa")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 宿主机执行下")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("777")]),s._v(" /opt/docker/jenkins/jenkins_home/id_rsa\n\n")])])])])}),[],!1,null,null,null);t.default=e.exports}}]);