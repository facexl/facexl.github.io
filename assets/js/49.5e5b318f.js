(window.webpackJsonp=window.webpackJsonp||[]).push([[49],{338:function(t,s,a){"use strict";a.r(s);var n=a(14),r=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"koa2搭建后端服务记录"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#koa2搭建后端服务记录"}},[t._v("#")]),t._v(" koa2搭建后端服务记录")]),t._v(" "),s("h3",{attrs:{id:"启动"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#启动"}},[t._v("#")]),t._v(" 启动")]),t._v(" "),s("ul",[s("li",[t._v("开发阶段使用"),s("code",[t._v("nodemon")]),t._v("修改文件自动重启")]),t._v(" "),s("li",[t._v("线上环境使用"),s("code",[t._v("pm2")]),t._v("，pm2 类似 nodemon，不同之处是当系统奔溃 pm2 会重启 app。当 app 需要多核处理时，pm2 内部集成负载均衡可以指定运行多少实例(pm2 start app.js -i max)")])]),t._v(" "),s("h3",{attrs:{id:"参数接收"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参数接收"}},[t._v("#")]),t._v(" 参数接收")]),t._v(" "),s("ul",[s("li",[t._v("post 请求使用 "),s("code",[t._v("koa-bodyparser")]),t._v("解析参数，post 请求 "),s("code",[t._v("ctx.request.body")]),t._v("，get 请求直接 "),s("code",[t._v("ctx.request.query")])])]),t._v(" "),s("h3",{attrs:{id:"密码存储与验证"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#密码存储与验证"}},[t._v("#")]),t._v(" 密码存储与验证")]),t._v(" "),s("p",[s("code",[t._v("bcrypt")]),t._v("是单向hash加密算法，不可反向破解生成明文，在 node 中可以这样使用：")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" i bcrypt "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--save")]),t._v("\n\n")])])]),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" bcrypt "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'bcrypt'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//生成salt的迭代次数(默认10次)")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" saltRounds "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//随机生成盐值")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" salt "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" bcrypt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("genSaltSync")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("saltRounds"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 把密码(123456)加密成hash值")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" hash "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" bcrypt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("hashSync")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'123456'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" salt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// hash 存入数据库，下次用户登录，用以下方式比较:")]),t._v("\nbcrypt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("compareSync")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'password'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'passwordHash'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// true or false")]),t._v("\n\n")])])]),s("h3",{attrs:{id:"登录-鉴权"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#登录-鉴权"}},[t._v("#")]),t._v(" 登录&鉴权")]),t._v(" "),s("p",[t._v("考虑了 jwt 的验证方式然后放弃了，原因之一是服务端不保存状态会导致无法强行让某个 token 失效")]),t._v(" "),s("h3",{attrs:{id:"错误处理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#错误处理"}},[t._v("#")]),t._v(" 错误处理")]),t._v(" "),s("h3",{attrs:{id:"数据库交互"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#数据库交互"}},[t._v("#")]),t._v(" 数据库交互")]),t._v(" "),s("p",[s("code",[t._v("sequelize")])]),t._v(" "),s("p",[s("code",[t._v("sequelize-cli")])]),t._v(" "),s("h3",{attrs:{id:"数据解析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#数据解析"}},[t._v("#")]),t._v(" 数据解析")]),t._v(" "),s("h3",{attrs:{id:"业务逻辑层"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#业务逻辑层"}},[t._v("#")]),t._v(" 业务逻辑层")])])}),[],!1,null,null,null);s.default=r.exports}}]);