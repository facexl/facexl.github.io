import{d as e,i as a,r as l,m as s,o as t,l as n,a as i,b as o,e as d,w as u,f as m,k as p,$ as r,M as c,q as _,F as v,n as g,p as b,z as h,cb as f,s as y,A as k,I as w,V as x,W as U,B as j,E as C,_ as S,G as N,H as D,T as L,x as I,v as B}from"./index-c2ae2a0e.js";import{u as O,_ as q}from"./useTableColumns-dd067b4d.js";import{R as A,_ as M}from"./index-c8577ae4.js";import"./index-3f0a4d2e.js";import{_ as T}from"./index-ef11d20c.js";import{u as E,a as F}from"./useSearchItems-c7d75cf3.js";import{u as z}from"./usePagination-c05046ed.js";import{_ as K}from"./ConnectUser.vue_vue_type_script_setup_true_lang-4d6feebd.js";import{d as R}from"./index-a09a23de.js";import"./FolderOpenOutlined-fa174baf.js";import"./tool-d986b095.js";import"./RadioButton-bc4165ed.js";import"./index-975d3375.js";const Z=S(e({__name:"NewModule",props:{show:Boolean,id:Number,smsBussiness:Object},emits:["fresh"],setup(e,{emit:S}){const N=e,D=a(N,"show",S),L=l(),I={required:!0,message:"请输入"},B=s({loading:!1}),O=s({template_name:void 0,sms_type:1,bussiness_node:void 0,template_code:void 0,template_params:[],sms_group:3,sms_user_id:"",sign:"AMSZ"});t((()=>{})),n(D,(e=>{e&&(L.value&&L.value.resetFields(),N.id&&(B.loading=!0,r.user.moduleList.smsDetail({id:N.id}).then((e=>{let a=[];e.data.template_params=JSON.parse(e.data.template_params),e.data.sms_user_id&&(e.data.sms_user_id=JSON.parse(e.data.sms_user_id),e.data.sms_user_id=e.data.sms_user_id.join(","));for(let l in e.data.template_params)a.push({label:l,value:e.data.template_params[l]});e.data.template_params=a;for(let l in O)void 0!==e.data[l]&&(O[l]=e.data[l]);console.log(O),setTimeout((e=>{B.loading=!1}),50)}))))}));const q=()=>{O.template_params.push({value:"",label:""})},T=()=>{L.value.validate().then((async e=>{let a={};e.template_params.forEach((e=>{a[e.label]=e.value})),e.template_params=a,await r.user.moduleList[N.id?"smsEdit":"smsAdd"]({...e,id:N.id||void 0}),D.value=!1,S("fresh")})).catch((e=>{console.log(e)}))};return(a,l)=>{const s=k,t=w,n=A,r=x,S=U,N=M,E=j,F=K,z=C,R=c;return i(),o("div",null,[d(R,{visible:m(D),"onUpdate:visible":l[7]||(l[7]=e=>p(D)?D.value=e:null),width:"1000px",title:e.id?"编辑短信模板":"添加短信模板","mask-closable":!1,onOk:T},{default:u((()=>[d(z,{ref_key:"formRef",ref:L,model:m(O),autocomplete:"off","label-col":{span:5},"wrapper-col":{span:15}},{default:u((()=>[d(s,{label:"模板类型"},{default:u((()=>[_(" 短信模板 ")])),_:1}),d(s,{name:"template_name",label:"模板名称",rules:I},{default:u((()=>[d(t,{value:m(O).template_name,"onUpdate:value":l[0]||(l[0]=e=>m(O).template_name=e),maxlength:30,placeholder:"请输入模板名称",style:{width:"400px"}},null,8,["value"])])),_:1}),d(s,{label:"短信模板ID：",name:"template_code",rules:I},{default:u((()=>[d(t,{value:m(O).template_code,"onUpdate:value":l[1]||(l[1]=e=>m(O).template_code=e),autocomplete:"off",style:{width:"400px"}},null,8,["value"])])),_:1}),d(s,{label:"发送规则",name:"sms_type",rules:I},{default:u((()=>[d(N,{value:m(O).sms_type,"onUpdate:value":l[3]||(l[3]=e=>m(O).sms_type=e)},{default:u((()=>[d(n,{value:1,style:{"margin-top":"3px","vertical-align":"middle"}},{default:u((()=>[_(" 业务触发 ")])),_:1}),d(s,{name:"bussiness_node",style:{display:"inline-block"},label:"",rules:I,"label-col":{},"wrapper-col":{}},{default:u((()=>[d(S,{value:m(O).bussiness_node,"onUpdate:value":l[2]||(l[2]=e=>m(O).bussiness_node=e),"allow-clear":"",placeholder:"请选择",style:{width:"200px"}},{default:u((()=>[(i(!0),o(v,null,g(e.smsBussiness,((e,a)=>(i(),b(r,{key:a,value:a},{default:u((()=>[_(h(e),1)])),_:2},1032,["value"])))),128))])),_:1},8,["value"])])),_:1})])),_:1},8,["value"])])),_:1}),d(s,{name:"template_params",label:"模板内容"},{default:u((()=>[(i(!0),o(v,null,g(m(O).template_params||[],((e,a)=>(i(),o("div",{key:a},[d(s,{name:`template_params[${a}]['label']`,label:"",class:f(0===a?"":"no-label-colon"),style:{display:"inline-block"}},{default:u((()=>[d(t,{value:e.label,"onUpdate:value":a=>e.label=a,style:{width:"200px","margin-right":"10px"},placeholder:"短信变量"},null,8,["value","onUpdate:value"])])),_:2},1032,["name","class"]),d(s,{name:`template_params[${a}]['value']`,label:"",class:f(0===a?"":"no-label-colon"),style:{display:"inline-block"}},{default:u((()=>[d(t,{value:e.value,"onUpdate:value":a=>e.value=a,style:{width:"200px"},placeholder:"系统对应值"},null,8,["value","onUpdate:value"]),d(E,{type:"link",class:"danger-color",onClick:e=>(e=>{O.template_params.splice(e,1)})(a)},{default:u((()=>[_(" 删除 ")])),_:2},1032,["onClick"])])),_:2},1032,["name","class"])])))),128)),d(s,{label:" ",class:f("no-label-colon")},{default:u((()=>[d(E,{onClick:q},{default:u((()=>[_(" 添加 ")])),_:1})])),_:1})])),_:1}),d(s,{name:"sign",label:"短信签名"},{default:u((()=>[d(N,{value:m(O).sign,"onUpdate:value":l[4]||(l[4]=e=>m(O).sign=e)},{default:u((()=>[d(n,{value:"AMSZ"},{default:u((()=>[_(h("AMSZ"))])),_:1})])),_:1},8,["value"])])),_:1}),d(s,{name:"sms_group",label:"发放对象"},{default:u((()=>[d(N,{value:m(O).sms_group,"onUpdate:value":l[6]||(l[6]=e=>m(O).sms_group=e)},{default:u((()=>[d(n,{value:3,style:{display:"block"}},{default:u((()=>[d(s,{label:"自定义用户",name:"sms_user_id",style:{display:"inline-block",width:"520px"}},{default:u((()=>[m(D)&&!m(B).loading?(i(),b(F,{key:0,uids:m(O).sms_user_id,"onUpdate:uids":l[5]||(l[5]=e=>m(O).sms_user_id=e),"show-name":"id"},null,8,["uids"])):y("",!0)])),_:1})])),_:1}),d(n,{value:0,style:{display:"block"}},{default:u((()=>[_(" 全部用户 ")])),_:1})])),_:1},8,["value"])])),_:1})])),_:1},8,["model"])])),_:1},8,["visible","title"])])}}}),[["__scopeId","data-v-99732c69"]]),$={key:1},J=e({__name:"ModuleList",setup(e){const a=E([["input","template_name","模板名称"],["input","id","模板ID"],["select","enabled","消息状态"]]),l=O([["模板ID","id"],["模板名称","template_name",250],["发放对象","sms_group"],["状态","enabled"],["操作","operate",180,"right"]]),n=s({activeName:"sms",dataSource:[],loading:!1,query:{},pagination:z(),showNewDialog:!1,handlingId:0,smsBussiness:{}});t((()=>{p(),c()}));const p=()=>{n.loading=!0,r.user.moduleList.smsList({page:n.pagination.current,page_size:n.pagination.pageSize,...n.query}).then((e=>{var l;n.loading=!1,n.dataSource=e.data.items,1===n.pagination.current&&(n.pagination.total=+(null==(l=e.data)?void 0:l.count)),F(a,"enabled",[{value:1,label:"开启"},{value:0,label:"关闭"}])}))},c=()=>{n.loading=!0,r.user.moduleList.smsBussiness({},{handleSelf:!0}).then((e=>{console.log(e),n.smsBussiness=e.sms_bussiness}))},v=e=>{n.pagination={...n.pagination,...e},p()},g=e=>{n.query=e,n.pagination={...n.pagination,current:1},p()};return(e,s)=>{const t=B,c=L,h=j,f=N("Search"),k=T,w=q,x=D("permission");return i(),o("div",null,[d(c,{activeKey:m(n).activeName,"onUpdate:activeKey":s[0]||(s[0]=e=>m(n).activeName=e)},{default:u((()=>[d(t,{key:"sms",tab:"短信模板",disabled:m(n).loading&&"sms"!==m(n).activeName},null,8,["disabled"])])),_:1},8,["activeKey"]),d(f,{"search-options":m(a),onOnSearch:g},{default:u((()=>[I((i(),b(h,{type:"primary",onClick:s[1]||(s[1]=e=>{m(n).handlingId=0,m(n).showNewDialog=!0})},{default:u((()=>[_(" 添加模板 ")])),_:1})),[[x,[m(r).user.moduleList.smsAdd]]])])),_:1},8,["search-options"]),d(w,{"data-source":m(n).dataSource,columns:m(l),scroll:{x:"max-content"},loading:m(n).loading,pagination:m(n).pagination,onChange:v},{bodyCell:u((({column:e,record:a})=>["enabled"===e.key?(i(),b(k,{key:0,checked:a.enabled,"onUpdate:checked":e=>a.enabled=e,"un-checked-value":0,"checked-value":1,onChange:e=>(async e=>{await r.user.moduleList.smsStatus({id:e.id,enabled:e.enabled}).catch((a=>{e.enabled=1===e.enabled?0:1}))})(a)},null,8,["checked","onUpdate:checked","onChange"])):y("",!0),"operate"===e.key?(i(),o("div",$,[I((i(),b(h,{type:"link",onClick:e=>{m(n).handlingId=a.id,m(n).showNewDialog=!0}},{default:u((()=>[_(" 编辑 ")])),_:2},1032,["onClick"])),[[x,[m(r).user.moduleList.smsEdit]]]),I((i(),b(h,{type:"link",class:"danger-color",onClick:e=>{return l=a.id,void R.confirm({title:"提示",content:"确认删除该模板？",okText:"确认",cancelText:"取消",onOk:()=>{r.user.moduleList.smsDelete({id:l}).then((e=>{p()}))}});var l}},{default:u((()=>[_(" 删除 ")])),_:2},1032,["onClick"])),[[x,[m(r).user.moduleList.smsDelete]]])])):y("",!0)])),_:1},8,["data-source","columns","loading","pagination"]),d(Z,{id:m(n).handlingId,show:m(n).showNewDialog,"onUpdate:show":s[2]||(s[2]=e=>m(n).showNewDialog=e),"sms-bussiness":m(n).smsBussiness,onFresh:p},null,8,["id","show","sms-bussiness"])])}}});export{J as default};
