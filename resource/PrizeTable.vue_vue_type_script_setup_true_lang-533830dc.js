import{d as e,h as a,a0 as l,i as t,r,l as d,m as n,a as s,b as u,e as i,w as o,f as p,k as m,F as _,n as c,p as v,q as y,z as f,s as b,g as w,a1 as k,$ as h,Z as g,A as x,V as U,W as z,I as j,E as q,B as C,D as E,S as P,a2 as A}from"./index-c2ae2a0e.js";import{u as L,_ as D}from"./useTableColumns-dd067b4d.js";import"./index-c8577ae4.js";import"./index-3f0a4d2e.js";import{_ as S}from"./index-00d344de.js";import{_ as B}from"./index-ef11d20c.js";import{_ as F}from"./index-8036da2a.js";import{p as I,l as T,a as K,b as R}from"./luckSpinConstant-6ba453a8.js";import{_ as H}from"./index-975d3375.js";import{_ as N}from"./Upload-053b6740.js";import{u as O,a as V}from"./useRequest-34a5e624.js";import{d as W}from"./dtool-b3945d0c.js";import{_ as Z}from"./tool-d986b095.js";import{B as $}from"./big-9da3d0c1.js";const G=w("span",null,"%",-1),J=e({__name:"PrizeEdit",props:{show:Boolean,data:Object},emits:["submit"],setup(e,{emit:w}){const A=e,L=a(),D=O(),S=V(),K=(e,a)=>(a.label+a.value).includes(e),R=l("enums"),$=t(A,"show",w,!1),J=r();d($,(e=>{e&&(J.value&&J.value.resetFields(),k((()=>{le()})))}));const M=n({sort:"",level:"",type:"",award_name:"",bonus:"",num:"",award_num:1,award_ext_id:"",award_id:"",award_rate:"",is_announce:0,id:0,member_types:R.value.member_type.map((e=>e.value)),cover:"",is_default:0}),Q=n({loading:!1,confirmLoading:!1,skuList:[]});d((()=>M.award_id),(()=>{4==+M.type&&(Q.skuList=[],ee())}));const X=()=>{M.award_ext_id=""},Y=()=>{M.award_id="",M.award_ext_id=""},ee=async()=>{const e=await h.product.goods.sku({goods_id:M.award_id});Q.skuList=e.data},ae=()=>{J.value.validate().then((async e=>{const a=W(M).join(["member_types"]).end();if(0==a.type&&(a.num=-1),0!=a.type&&a.num<0)return a.num=-1,void g.error("奖品剩余数量不能为负数");"modPrizes"===L.name&&await h.act.spin.editAward({...a,activity_id:L.params.id}),w("submit",a),$.value=!1}))},le=()=>{W(A.data).split(["member_types"]).stringArrToNumber(["member_types"]).insertForm(M)};return(e,a)=>{const l=F,t=x,r=U,d=z,n=U,w=z,k=x,h=j,g=N,A=B,O=Z,V=q,W=C,ee=E,le=P,te=H;return s(),u("div",null,[i(te,{visible:p($),"onUpdate:visible":a[15]||(a[15]=e=>m($)?$.value=e:null),title:"编辑奖品",placement:"right",width:"50%"},{default:o((()=>[i(le,{spinning:p(Q).loading},{default:o((()=>[i(V,{ref_key:"formRef",ref:J,model:p(M),autocomplete:"off","label-col":{span:4},"wrapper-col":{span:14}},{default:o((()=>[i(t,{name:"sort",label:"排序",required:""},{default:o((()=>[i(l,{value:p(M).sort,"onUpdate:value":a[0]||(a[0]=e=>p(M).sort=e),placeholder:"请输入",min:0,precision:0},null,8,["value"])])),_:1}),i(t,{name:"type",label:"奖品类型",required:""},{default:o((()=>[i(d,{value:p(M).type,"onUpdate:value":a[1]||(a[1]=e=>p(M).type=e),placeholder:"请选择",disabled:"modPrizes"===p(L).name,onChange:Y},{default:o((()=>[(s(!0),u(_,null,c(p(I),(e=>(s(),v(r,{key:e.type,value:e.type},{default:o((()=>[y(f(e.name),1)])),_:2},1032,["value"])))),128))])),_:1},8,["value","disabled"])])),_:1}),i(t,{name:"level",label:"价值分类",required:""},{default:o((()=>[i(d,{value:p(M).level,"onUpdate:value":a[2]||(a[2]=e=>p(M).level=e),placeholder:"请选择"},{default:o((()=>[(s(!0),u(_,null,c(p(T),(e=>(s(),v(r,{key:e.level,value:e.level},{default:o((()=>[y(f(e.name),1)])),_:2},1032,["value"])))),128))])),_:1},8,["value"])])),_:1}),1==+p(M).type?(s(),v(t,{key:0,name:"bonus",label:"余额红包",required:""},{default:o((()=>[i(l,{value:p(M).bonus,"onUpdate:value":a[3]||(a[3]=e=>p(M).bonus=e),placeholder:"请输入",min:0},null,8,["value"])])),_:1})):b("",!0),2==+p(M).type?(s(),v(t,{key:1,name:"award_id",label:"商品满减券",required:""},{default:o((()=>[i(w,{value:p(M).award_id,"onUpdate:value":a[4]||(a[4]=e=>p(M).award_id=e),placeholder:"请选择","show-search":"","allow-clear":"","filter-option":K},{default:o((()=>[(s(!0),u(_,null,c(p(S),(e=>(s(),v(n,{key:e.id,value:e.id,label:e.name},{default:o((()=>[y(f(e.name)+"-"+f(e.id),1)])),_:2},1032,["value","label"])))),128))])),_:1},8,["value"])])),_:1})):b("",!0),4==+p(M).type?(s(),v(k,{key:2,label:"商品",name:"award_id",rules:[{required:!0,message:"请选择"}]},{default:o((()=>[i(w,{value:p(M).award_id,"onUpdate:value":a[5]||(a[5]=e=>p(M).award_id=e),placeholder:"请选择商品","show-search":"","allow-clear":"","filter-option":K,onChange:X},{default:o((()=>[(s(!0),u(_,null,c(p(D),(e=>(s(),v(n,{key:e.id,value:e.id,label:e.title},{default:o((()=>[y(f(e.title)+"-"+f(e.id),1)])),_:2},1032,["value","label"])))),128))])),_:1},8,["value"])])),_:1})):b("",!0),4==+p(M).type?(s(),v(k,{key:3,label:"商品SKU",name:"award_ext_id",rules:[{required:!0,message:"请选择"}]},{default:o((()=>[i(w,{value:p(M).award_ext_id,"onUpdate:value":a[6]||(a[6]=e=>p(M).award_ext_id=e),placeholder:"请选择商品SKU","show-search":"","allow-clear":"","filter-option":K},{default:o((()=>[(s(!0),u(_,null,c(p(Q).skuList,(e=>(s(),v(n,{key:e.id,value:e.id},{default:o((()=>[y(f(e.properties_name),1)])),_:2},1032,["value"])))),128))])),_:1},8,["value"])])),_:1})):b("",!0),i(t,{name:"award_name",label:"奖品名称",required:""},{default:o((()=>[i(h,{value:p(M).award_name,"onUpdate:value":a[7]||(a[7]=e=>p(M).award_name=e),placeholder:"请输入",maxlength:7,"show-count":""},null,8,["value"])])),_:1}),0!=+p(M).type?(s(),v(t,{key:4,name:"award_num",label:"单次中奖赠送件数",required:"","label-col":{span:6}},{default:o((()=>[i(l,{value:p(M).award_num,"onUpdate:value":a[8]||(a[8]=e=>p(M).award_num=e),placeholder:"请输入",min:1,precision:0},null,8,["value"])])),_:1})):b("",!0),i(t,{name:"cover",label:"奖品图片",required:""},{default:o((()=>[i(g,{filelist:p(M).cover,"onUpdate:filelist":a[9]||(a[9]=e=>p(M).cover=e)},null,8,["filelist"])])),_:1}),i(k,{label:"中奖后是否公布","label-col":{span:4},"wrapper-col":{span:16}},{default:o((()=>[i(A,{checked:p(M).is_announce,"onUpdate:checked":a[10]||(a[10]=e=>p(M).is_announce=e),"un-checked-value":0,"checked-value":1},null,8,["checked"])])),_:1}),i(t,{name:"member_types",label:"身份限制"},{default:o((()=>[i(O,{value:p(M).member_types,"onUpdate:value":a[11]||(a[11]=e=>p(M).member_types=e),options:p(R).member_type},null,8,["value","options"])])),_:1}),i(t,{name:"award_rate",label:"中奖率",required:""},{default:o((()=>[i(l,{value:p(M).award_rate,"onUpdate:value":a[12]||(a[12]=e=>p(M).award_rate=e),min:0,disabled:"modPrizes"===p(L).name},{addonAfter:o((()=>[G])),_:1},8,["value","disabled"])])),_:1}),0!=+p(M).type?(s(),v(t,{key:5,name:"num",label:"奖品剩余数量",required:""},{default:o((()=>[i(l,{value:p(M).num,"onUpdate:value":a[13]||(a[13]=e=>p(M).num=e),min:0,precision:0},null,8,["value"])])),_:1})):b("",!0)])),_:1},8,["model"]),i(ee,{class:"flex-center"},{default:o((()=>[i(W,{type:"primary",class:"mr16px",loading:p(Q).confirmLoading,onClick:ae},{default:o((()=>[y(" 确定 ")])),_:1},8,["loading"]),i(W,{type:"default",onClick:a[14]||(a[14]=e=>$.value=!1)},{default:o((()=>[y(" 取消 ")])),_:1})])),_:1})])),_:1},8,["spinning"])])),_:1},8,["visible"])])}}}),M={key:0},Q={key:0},X={key:1},Y={key:2},ee={key:3},ae={style:{color:"#999"},class:"mt16px"},le=e({__name:"PrizeTable",props:{prizes:Array},setup(e,{expose:a}){const t=e,r=l("enums"),m=L([["排序","sort"],["奖品名称","award_name"],["奖品类型","type"],["可领取用户类型","member_types"],["价值分类","level"],["图标","cover"],["中奖率","award_rate"],["奖品剩余数量","num"],["抽中数量","lucky_num"],["默认奖品","is_default"],["操作","operate",180,"right"]]),c=n({prizes:new Array(8).fill("").map(((e,a)=>function(e=0){return{id:0,type:0,level:10,bonus:"",award_id:"",award_ext_id:"",award_name:"",award_num:1,cover:"",is_announce:0,num:"",award_rate:"",sort:e,is_default:0,member_types:r.value.member_type.map((e=>e.value)).join(",")}}(a+1))),prizeEditData:{},showPrizeEdit:!1,handlingIndex:0,total_rate:0});a({submit:()=>c}),d((()=>t.prizes),(e=>{c.prizes=e})),d((()=>c.prizes),(e=>{c.total_rate=+e.map((e=>+e.award_rate)).reduce(((e,a)=>$(+e).plus(+a)))}),{deep:!0});const k=e=>{c.prizes[c.handlingIndex]=e},h=e=>{const a=r.value.member_type.reduce(((e,a)=>(e[a.value]=a.label,e)),{});return e.split(",").map((e=>a[e])).join("+")};return(e,a)=>{const l=F,t=B,d=S,n=C,g=D;return s(),u("div",null,[i(g,{"row-key":"id","data-source":p(c).prizes,columns:p(m),scroll:{x:"max-content"},pagination:!1},{bodyCell:o((({column:e,record:a,index:i})=>["type"===e.key?(s(),u("span",M,f(p(K)[a.type]),1)):b("",!0),"num"===e.key?(s(),u(_,{key:1},[-1==+a.num?(s(),u("span",Q,"无限")):(s(),u("span",X,f(a.num),1))],64)):b("",!0),"member_types"===e.key?(s(),u("span",Y,f(h(a.member_types)),1)):b("",!0),"level"===e.key?(s(),u("span",ee,f(p(R)[a.level]),1)):b("",!0),"award_rate"===e.key?(s(),v(l,{key:4,value:a.award_rate,"onUpdate:value":e=>a.award_rate=e,min:0},null,8,["value","onUpdate:value"])):b("",!0),"is_default"===e.key?(s(),v(t,{key:5,checked:a.is_default,"onUpdate:checked":e=>a.is_default=e,"un-checked-value":0,"checked-value":1,onChange:e=>{return l=a,c.prizes.forEach((e=>{e.is_default=0})),l.member_types=r.value.member_type.map((e=>e.value)).join(","),void(l.is_default=1);var l}},null,8,["checked","onUpdate:checked","onChange"])):b("",!0),"cover"===e.key?(s(),v(d,{key:6,width:50,height:50,src:a.cover},null,8,["src"])):b("",!0),"operate"===e.key?(s(),v(n,{key:7,type:"link",onClick:e=>{p(c).showPrizeEdit=!0,p(c).prizeEditData=a,p(c).handlingIndex=i}},{default:o((()=>[y(" 编辑 ")])),_:2},1032,["onClick"])):b("",!0)])),_:1},8,["data-source","columns"]),w("p",ae,[y(" 当前中奖率合计： "),w("span",{style:A({color:100==p(c).total_rate?"#0bb90b":"red"})},f(p(c).total_rate)+"%",5)]),i(J,{show:p(c).showPrizeEdit,"onUpdate:show":a[0]||(a[0]=e=>p(c).showPrizeEdit=e),data:p(c).prizeEditData,onSubmit:k},null,8,["show","data"])])}}});export{le as _};
