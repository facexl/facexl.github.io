import{d as a,i as e,r as t,m as o,o as r,l as n,$ as s,a as l,b as i,e as p,w as d,f as u,k as c,Z as f,M as m,q as _,p as g,s as h,I as y,A as v,cR as w,B as k,E as b,_ as N,G as S,H as x,x as O}from"./index-c2ae2a0e.js";import{u as U,_ as F}from"./useTableColumns-dd067b4d.js";import{R as J,_ as j}from"./index-c8577ae4.js";import{C}from"./index-3f0a4d2e.js";import{u as I,a as $}from"./useSearchItems-c7d75cf3.js";import{u as L}from"./usePagination-c05046ed.js";import{_ as q}from"./tool-d986b095.js";import{d as D}from"./index-a09a23de.js";import"./FolderOpenOutlined-fa174baf.js";import"./RadioButton-bc4165ed.js";const E={key:0},R={key:5},T=N(a({__name:"NewFreightFormwork",props:{show:Boolean,id:Number,handlingInfo:{type:Object,default:()=>{}}},emits:["fresh"],setup(a,{emit:N}){const S=a;I([]);const x=U([["运送到","area_codes",550],["首","first_num",150],["首费(元)","first_price",150],["续","follow_num",150],["续费(元)","follow_price",150],["操作","operate",70]]),O=e(S,"show",N),$=t(),L={required:!0,message:"请输入"},D={first_num:"",area_codes:[],first_price:"",follow_num:"",follow_price:""},T=o({loading:!1,areaList:[],transports_old:[]}),A=o({name:"",type:void 0,transport_type:[],transports:[]});r((()=>{B()})),n(O,(a=>{a?($.value&&$.value.resetFields(),S.id&&(T.loading=!0,s.set.freightFormwork.detail({id:S.id}).then((a=>{a.data.transport_type&&(a.data.transport_type=[a.data.transport_type]),a.data.transports.forEach((a=>{a.area_codes.forEach(((e,t)=>{let o=[],r=(a,t,o)=>{for(let n=0;n<a.length;n++){let s=JSON.parse(JSON.stringify(o));if(s.push(n),+a[n].code==+t)return s;if(a[n].items){let t=r(a[n].items,e,s);if(t)return t}}},n=r(T.areaList,e,[]),s=JSON.parse(JSON.stringify(T.areaList));n.forEach(((a,e)=>{o[e]=s[a].code,s=s[a].items?JSON.parse(JSON.stringify(s[a].items)):[]})),a.area_codes[t]=o}))}));for(let e in A)void 0!==a.data[e]&&(A[e]=a.data[e]);T.transports_old=JSON.parse(JSON.stringify(a.data.transports)),setTimeout((a=>{T.loading=!1}),50)})))):(T.transports=[],T.transports_old=[])})),n((()=>A.transport_type),(a=>{a[0]||(A.transports=JSON.parse(JSON.stringify(T.transports_old)))}));const B=()=>{s.common.getAllAreaList({}).then((a=>{a.data.forEach(((a,e)=>{a.code=e})),T.areaList=a.data}))},z=()=>{$.value.validate().then((async a=>{(a=JSON.parse(JSON.stringify(a))).transport_type=a.transport_type[0];for(let e=0;e<a.transports.length;e++){if(!(a.transports[e].first_num&&a.transports[e].first_price&&a.transports[e].follow_num&&a.transports[e].follow_price&&0!==a.transports[e].area_codes.length))return f.info("物流信息填写完整");S.id&&!a.transports[e].id&&(a.transports[e].id=0),delete a.transports[e].areas,a.transports[e].area_codes=a.transports[e].area_codes.map((a=>{if(1===a.length)for(let e=0;e<T.areaList.length;e++)if(+T.areaList[e].code==+a[0]){return T.areaList[e].items.map((a=>a.code)).join(",")}return a[a.length-1]})).join(","),a.transports[e].area_codes=a.transports[e].area_codes.split(",")}await s.set.freightFormwork[S.id?"edit":"add"]({...a,id:S.id||void 0}),O.value=!1,N("fresh")})).catch((a=>{console.log(a)}))};return(e,t)=>{const o=y,r=v,n=J,s=j,f=C,N=q,S=w,U=k,I=F,B=b,G=m;return l(),i("div",null,[p(G,{visible:u(O),"onUpdate:visible":t[4]||(t[4]=a=>c(O)?O.value=a:null),width:"1300px",title:a.id?"编辑模板":"添加模板","mask-closable":!1,onOk:z},{default:d((()=>[p(B,{ref_key:"formRef",ref:$,model:u(A),autocomplete:"off","label-col":{span:2},"wrapper-col":{span:22}},{default:d((()=>[p(r,{name:"name",label:"模板名称",rules:[L]},{default:d((()=>[p(o,{value:u(A).name,"onUpdate:value":t[0]||(t[0]=a=>u(A).name=a),placeholder:"模板名称"},null,8,["value"])])),_:1},8,["rules"]),p(r,{name:"type",label:"计价方式"},{default:d((()=>[p(s,{value:u(A).type,"onUpdate:value":t[1]||(t[1]=a=>u(A).type=a)},{default:d((()=>[p(n,{value:2},{default:d((()=>[_(" 按件数 ")])),_:1})])),_:1},8,["value"])])),_:1}),p(r,{name:"transport_type",label:"运送方式"},{default:d((()=>[p(N,{value:u(A).transport_type,"onUpdate:value":t[2]||(t[2]=a=>u(A).transport_type=a)},{default:d((()=>[p(f,{value:1},{default:d((()=>[_(" 快递 ")])),_:1})])),_:1},8,["value"])])),_:1}),p(r,{name:"transports",label:"",style:{display:"none"}}),1===u(A).transport_type[0]&&u(O)?(l(),i("div",E,[p(I,{"data-source":u(A).transports,columns:u(x),scroll:{x:"max-content"},loading:u(T).loading,pagination:!1},{bodyCell:d((({column:a,record:e,index:t})=>["area_codes"===a.key?(l(),g(r,{key:0,name:`transports[${t}].area_codes`,label:"","wrapper-col":{span:24}},{default:d((()=>[p(S,{value:u(A).transports[t].area_codes,"onUpdate:value":a=>u(A).transports[t].area_codes=a,placeholder:"请选择区域",options:u(T).areaList,multiple:"","get-popup-container":a=>a.parentNode,"field-names":{label:"name",value:"code",children:"items"}},null,8,["value","onUpdate:value","options","get-popup-container"])])),_:2},1032,["name"])):h("",!0),"first_num"===a.key?(l(),g(r,{key:1,name:`transports[${e.$index}].first_num`,label:"","wrapper-col":{span:24}},{default:d((()=>[p(o,{value:u(A).transports[t].first_num,"onUpdate:value":a=>u(A).transports[t].first_num=a,placeholder:"请输入首件数"},null,8,["value","onUpdate:value"])])),_:2},1032,["name"])):h("",!0),"first_price"===a.key?(l(),g(r,{key:2,name:`transports[${e.$index}].first_price`,label:"","wrapper-col":{span:24}},{default:d((()=>[p(o,{value:u(A).transports[t].first_price,"onUpdate:value":a=>u(A).transports[t].first_price=a,placeholder:"请输入首费"},null,8,["value","onUpdate:value"])])),_:2},1032,["name"])):h("",!0),"follow_num"===a.key?(l(),g(r,{key:3,name:`transports[${e.$index}].follow_num`,label:"","wrapper-col":{span:24}},{default:d((()=>[p(o,{value:u(A).transports[t].follow_num,"onUpdate:value":a=>u(A).transports[t].follow_num=a,placeholder:"请输入续件数"},null,8,["value","onUpdate:value"])])),_:2},1032,["name"])):h("",!0),"follow_price"===a.key?(l(),g(r,{key:4,name:`transports[${e.$index}].follow_price`,label:"","wrapper-col":{span:24}},{default:d((()=>[p(o,{value:u(A).transports[t].follow_price,"onUpdate:value":a=>u(A).transports[t].follow_price=a,placeholder:"请输入续费"},null,8,["value","onUpdate:value"])])),_:2},1032,["name"])):h("",!0),"operate"===a.key?(l(),i("div",R,[p(U,{type:"link",class:"danger-color",onClick:a=>(a=>{A.transports.splice(a,1)})(t)},{default:d((()=>[_(" 删除 ")])),_:2},1032,["onClick"])])):h("",!0)])),_:1},8,["data-source","columns","loading"]),p(U,{type:"link",onClick:t[3]||(t[3]=a=>{A.transports.push(JSON.parse(JSON.stringify(D)))})},{default:d((()=>[_(" 为指定地区城市设置运费 ")])),_:1})])):h("",!0)])),_:1},8,["model"])])),_:1},8,["visible","title"])])}}}),[["__scopeId","data-v-47c6215b"]]),A=["src"],B={key:1},z=a({__name:"FreightFormwork",setup(a){const e=I([["input","id","模板ID"],["input","name","模板名称"]]),t=U([["编号","id"],["模板名称","name"],["计价方式","type_name"],["操作","operate",130,"right"]]),n=o({handlingId:0,dataSource:[],loading:!1,query:{},pagination:L(),showNewDialog:!1,handlingInfo:{}});r((()=>{c()}));const c=()=>{n.loading=!0,s.set.freightFormwork.list({page:n.pagination.current,page_size:n.pagination.pageSize,...n.query}).then((a=>{var t;n.loading=!1,n.dataSource=a.data.items,1===n.pagination.current&&(n.pagination.total=+(null==(t=a.data)?void 0:t.count)),$(e,"enabled",a.data.enabled_map)}))},f=a=>{n.pagination={...n.pagination,...a},c()},m=a=>{n.query=a,n.pagination={...n.pagination,current:1},c()};return(a,o)=>{const r=k,y=S("Search"),v=F,w=x("permission");return l(),i("div",null,[p(y,{"search-options":u(e),onOnSearch:m},{default:d((()=>[O((l(),g(r,{type:"primary",onClick:o[0]||(o[0]=a=>{u(n).handlingId=0,u(n).handlingInfo={},u(n).showNewDialog=!0})},{default:d((()=>[_(" 添加 ")])),_:1})),[[w,[u(s).set.freightFormwork.add]]])])),_:1},8,["search-options"]),p(v,{"data-source":u(n).dataSource,columns:u(t),scroll:{x:"max-content"},loading:u(n).loading,pagination:u(n).pagination,onChange:f},{bodyCell:d((({column:a,record:e})=>["icon"===a.key?(l(),i("img",{key:0,style:{width:"70px"},src:e.icon},null,8,A)):h("",!0),"operate"===a.key?(l(),i("div",B,[O((l(),g(r,{type:"link",onClick:a=>{u(n).handlingId=e.id,u(n).handlingInfo=e,u(n).showNewDialog=!0}},{default:d((()=>[_(" 编辑 ")])),_:2},1032,["onClick"])),[[w,[u(s).set.freightFormwork.edit]]]),O((l(),g(r,{type:"link",class:"danger-color",onClick:a=>{return t=e.id,void D.confirm({title:"提示",content:"确认删除该模板？",okText:"确认",cancelText:"取消",onOk:()=>{s.set.freightFormwork.delete({id:t+""}).then((a=>{c()}))}});var t}},{default:d((()=>[_(" 删除 ")])),_:2},1032,["onClick"])),[[w,[u(s).set.freightFormwork.delete]]])])):h("",!0)])),_:1},8,["data-source","columns","loading","pagination"]),p(T,{id:u(n).handlingId,show:u(n).showNewDialog,"onUpdate:show":o[1]||(o[1]=a=>u(n).showNewDialog=a),"handling-info":u(n).handlingInfo,onFresh:c},null,8,["id","show","handling-info"])])}}});export{z as default};
